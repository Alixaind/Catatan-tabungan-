<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catatan Pinjaman</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color-peminjam: #2196F3; /* Biru untuk peminjam */
      --primary-color-penerima: #FFC107; /* Kuning untuk penerima */
      --secondary-color: #f44336;
      --background-color: #f5f5f5;
      --card-bg: #ffffff;
      --text-color: #333333;
      --light-text-color: #666666;
      --border-color: #e0e0e0;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --border-radius: 8px;
    }
    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      background: var(--background-color);
      color: var(--text-color);
    }
    header {
      background: var(--primary-color-peminjam); /* Default ke Biru */
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 101;
    }
    body.penerima-theme header {
      background: var(--primary-color-penerima); /* Ganti ke Kuning */
    }
    header h1 {
      margin: 0;
      font-size: 22px;
    }
    #menuToggle {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
    }

    .menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    .hamburger-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100%;
      background: var(--card-bg);
      box-shadow: 4px 0 15px rgba(0,0,0,0.15);
      z-index: 100;
      transition: left 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }
    .hamburger-menu.open {
      left: 0;
    }
    .menu-header {
      padding: 1.5rem;
      background: var(--primary-color-peminjam); /* Default ke Biru */
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
    }
    body.penerima-theme .menu-header {
      background: var(--primary-color-penerima); /* Ganti ke Kuning */
    }
    .menu-list {
      flex-grow: 1;
      padding: 0;
      list-style: none;
      margin: 0;
    }
    .menu-list li {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }
    .menu-list li:hover {
        background-color: #f0f0f0;
    }
    .menu-list li:last-child {
      border-bottom: none;
    }
    .menu-list li a {
      text-decoration: none;
      color: var(--text-color);
      display: block;
      font-weight: 500;
    }
    .menu-list li button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: var(--secondary-color);
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      padding: 0;
    }
    .menu-list .user-info {
        font-weight: 600;
        color: var(--primary-color-peminjam); /* Default ke Biru */
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }
    body.penerima-theme .menu-list .user-info {
        color: var(--primary-color-penerima); /* Ganti ke Kuning */
    }
    .menu-list .found-nasabah {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-color);
        background-color: #e0f2f1; /* Warna hijau muda */
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .menu-list .found-nasabah:hover {
        background-color: #b2dfdb;
    }

    main {
      display: flex;
      padding: 15px;
      gap: 15px;
      padding-bottom: 80px;
    }
    .column {
      flex: 1;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }
    .column h2 {
      margin-top: 0;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }
    .list {
      flex-grow: 1;
    }
    .item {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item:last-child {
      border-bottom: none;
    }
    .item-info span {
      display: block;
      font-weight: 500;
    }
    .item-info small {
      font-size: 0.8em;
      color: var(--light-text-color);
    }
    .item button {
      background: var(--primary-color-peminjam);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    body.penerima-theme .item button {
        background: var(--primary-color-penerima);
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    footer .total {
      display: flex;
      flex-direction: column;
    }
    footer .total strong {
        font-size: 1.1em;
        color: var(--primary-color-peminjam); /* Default ke Biru */
    }
    body.penerima-theme footer .total strong {
        color: var(--primary-color-penerima); /* Ganti ke Kuning */
    }
    footer button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-bg {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      width: 500px;
      max-width: 95%;
      box-shadow: var(--shadow);
    }
    .modal h3 {
        margin-top: 0;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .modal label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .modal input, .modal select {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
    }
    .modal .actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      gap: 10px;
    }
    .modal .actions button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    #batalBtn {
        background: #ccc;
        color: var(--text-color);
    }
    #simpanBtn {
        background: #4CAF50;
        color: white;
    }
    .bukti-modal img {
      max-width: 100%;
      border-radius: 6px;
      display: block;
      margin: 0 auto;
    }
    
    .found-nasabah.selected {
  background-color: #ffeadb; /* Warna oranye muda */
  border: 2px solid var(--primary-color-penerima); /* Border oranye */
  border-left: 5px solid var(--primary-color-penerima); /* Garis tebal di kiri */
}
  </style>
</head>
<body>

<header>
  <button id="menuToggle">☰</button>
  <h1 id="mainTitle">Catatan Pinjaman</h1>
  <span id="saldoRingkas">Saldo: Rp 0</span>
</header>

<div class="menu-overlay" id="menuOverlay"></div>

<nav class="hamburger-menu" id="hamburgerMenu">
    <div class="menu-header">Menu</div>
    <ul class="menu-list">
        <li class="user-info">
            <span id="loggedInUserName"></span>
            <small>Email: <span id="loggedInUserEmail"></span></small>
            <small style="display:none">ID: <span id="loggedInUserId"></span></small>
        </li>
        <li>
            <label for="switchAkun" style="font-weight:600;">Tipe Akun:</label>
            <select id="switchAkun" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ccc;margin-top:5px;">
                <option value="peminjam">Pemberi Pinjaman</option>
                <option value="penerima">Penerima Pinjaman</option>
            </select>
        </li>
        <ul id="friendsList" style="list-style:none;padding:0;margin:0;"></ul>
        <li>
            <button id="tambahNasabahBtn" style="width: 100%; text-align: left; background: none; border: none; color: var(--text-color); font-size: 1rem; font-family: 'Poppins', sans-serif; cursor: pointer; padding: 1rem 1.5rem;">Tambahkan Nasabah</button>
        </li>
        <li>
        	<button onclick="window.location.href='settings.html';"style="width: 100%; text-align: left; background: none; border: none; color: var(--text-color); font-size: 1rem; font-family: 'Poppins', sans-serif; cursor: pointer; padding: 1rem 1.5rem;"> Pengaturan</button>
        	</li>
        <li><button id="logoutBtn">Logout</button></li>
    </ul>
</nav>

<main>
  <div class="column" id="keluar">
    <h2>Uang dipinjamkan</h2>
    <div class="list"></div>
  </div>
  <div class="column" id="masuk">
    <h2>Uang dikembalikan</h2>
    <div class="list"></div>
  </div>
</main>

<footer>
  <div class="total">
    <span id="totalKeluar">Total dipinjamkan: Rp 0</span>
    <span id="totalMasuk">Total dikembalikan: Rp 0</span>
    <strong id="saldo">Saldo (Belum Kembali): Rp 0</strong>
  </div>
  <button id="tambahBtn">➕ Tambah</button>
</footer>

<div class="modal-bg" id="modalForm">
  <div class="modal">
    <h3 id="formTitle">Tambah Catatan</h3>
    <label>Jenis</label>
    <select id="jenis">
      <option value="dipinjamkan">Uang dipinjamkan</option>
      <option value="dikembalikan">Uang dikembalikan</option>
    </select>
    <label>Nominal</label>
    <input type="text" id="nominal" placeholder="Rp 0">
    
    <label>Tanggal</label>
    <input type="date" id="tanggal">
    <label>Bukti Transfer</labe>
    <input type="file" id="bukti">
    <div class="actions">
      <button id="batalBtn">Batal</button>
      <button id="simpanBtn">Simpan</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modalBukti">
  <div class="modal bukti-modal">
    <h3>Bukti Transfer</h3>
    <img id="imgBukti" src="" alt="Bukti Transfer">
    <div class="actions">
      <button id="tutupBukti">Tutup</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modalLunasi">
  <div class="modal">
    <h3>Lunasi Pinjaman</h3>
    <p>Data pinjaman asli:</p>
    <label>Nominal</label>
    <input type="text" id="nominalAsli" readonly>
    <label>Tanggal Pinjam</label>
    <input type="date" id="tanggalPinjamAsli" readonly>

    <hr>
    
    <p>Masukkan data pengembalian:</p>
    <label>Tanggal Dikembalikan</label>
    <input type="date" id="tanggalDikembalikan">
    <label>Bukti Transfer Kembali</label>
    <input type="file" id="buktiKembali">

    <div class="actions">
      <button id="batalLunasiBtn">Batal</button>
      <button id="simpanLunasiBtn">Simpan</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modalNasabah">
  <div class="modal">
    <h3>Tambahkan Nasabah</h3>
    <p>Masukkan nama dan email untuk memeriksa apakah nasabah terdaftar.</p>
    <label>Nama</label>
    <input type="text" id="inputNasabahNama" placeholder="Contoh: Budi">
    <label>Email</label>
    <input type="email" id="inputNasabahEmail" placeholder="contoh@email.com">
    <div class="actions">
      <button id="batalNasabahBtn">Batal</button>
      <button id="simpanNasabahBtn">Konfirmasi</button>
    </div>
  </div>
</div>

<script>
    const SUPABASE_URL = 'https://wfjxvaybfdxhycbrxufw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indmanh2YXliZmR4aHljYnJ4dWZ3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDgwODM4NSwiZXhwIjoyMDcwMzg0Mzg1fQ.tTupZwezG2GIOSfOUwd7yP7WWn0ENL91Qb2ZAqGzEQQ';
    
    
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tambahBtn = document.getElementById('tambahBtn');
const modalForm = document.getElementById('modalForm');
const batalBtn = document.getElementById('batalBtn');
const simpanBtn = document.getElementById('simpanBtn');
const jenis = document.getElementById('jenis');
const nominal = document.getElementById('nominal');

const tanggal = document.getElementById('tanggal');
const bukti = document.getElementById('bukti');
const listMasuk = document.querySelector('#masuk .list');
const listKeluar = document.querySelector('#keluar .list');
const totalMasuk = document.getElementById('totalMasuk');
const totalKeluar = document.getElementById('totalKeluar');
const saldoEl = document.getElementById('saldo');
const saldoRingkas = document.getElementById('saldoRingkas');
const modalBukti = document.getElementById('modalBukti');
const imgBukti = document.getElementById('imgBukti');
const tutupBukti = document.getElementById('tutupBukti');
const menuToggle = document.getElementById('menuToggle');
const hamburgerMenu = document.getElementById('hamburgerMenu');
const menuOverlay = document.getElementById('menuOverlay');
const loggedInUserName = document.getElementById('loggedInUserName');
const loggedInUserEmail = document.getElementById('loggedInUserEmail');
const loggedInUserId = document.getElementById('loggedInUserId');
const mainTitle = document.getElementById('mainTitle');

const logoutBtn = document.getElementById('logoutBtn');
const tambahNasabahBtn = document.getElementById('tambahNasabahBtn');
const modalNasabah = document.getElementById('modalNasabah');
const inputNasabahNama = document.getElementById('inputNasabahNama');
const inputNasabahEmail = document.getElementById('inputNasabahEmail');
const batalNasabahBtn = document.getElementById('batalNasabahBtn');
const simpanNasabahBtn = document.getElementById('simpanNasabahBtn');
const switchAkun = document.getElementById('switchAkun');

// New elements for the "Lunasi" modal
const modalLunasi = document.getElementById('modalLunasi');
const nominalAsli = document.getElementById('nominalAsli');
const tanggalPinjamAsli = document.getElementById('tanggalPinjamAsli');
const tanggalDikembalikan = document.getElementById('tanggalDikembalikan');
const buktiKembali = document.getElementById('buktiKembali');
const batalLunasiBtn = document.getElementById('batalLunasiBtn');
const simpanLunasiBtn = document.getElementById('simpanLunasiBtn');
const friendsList = document.getElementById('friendsList');

let currentUserId = null;
let allLoanData = [];
let userProfile = null;
let selectedFriendId = null;
let selectedFriendName = null;

let loanToRepayId = null; // Variable untuk menyimpan ID pinjaman yang akan dilunasi

// Debug log collector
function debugLog(msg, data) {
    const time = new Date().toLocaleTimeString();
    console.log(`[${time}] ${msg}`, data || '');
}

function formatRupiah(angka) {
    if (angka === null || angka === undefined) return 'Rp 0';
    let number_string = angka.toString().replace(/[^,\d]/g, '');
    let split = number_string.split(',');
    let sisa = split[0].length % 3;
    let rupiah = split[0].substr(0, sisa);
    let ribuan = split[0].substr(sisa).match(/\d{3}/gi);
    if (ribuan) {
        let separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
    }
    rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
    return 'Rp ' + rupiah;
}

document.addEventListener('DOMContentLoaded', async () => {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
        window.location.href = 'index.html';
        return;
    }
    currentUserId = user.id;
    debugLog("✅ User login", currentUserId);

    const { data: profileData, error: profileError } = await supabaseClient
        .from('profiles')
        .select('email, nama, tipe_akun')
        .eq('id', currentUserId)
        .single();

    if (profileError) {
        console.error("Gagal mengambil data profil:", profileError);
        loggedInUserName.textContent = user.email;
    } else {
        userProfile = profileData;
        loggedInUserName.textContent = profileData.nama || profileData.email;
        loggedInUserEmail.textContent = profileData.email;
        switchAkun.value = userProfile.tipe_akun;
        updateThemeAndLabels(userProfile.tipe_akun);
        updateUIBasedOnAccountType(userProfile.tipe_akun); // Call this on load
    }

    loggedInUserId.textContent = currentUserId;
    fetchData();
    await loadNasabahList();

    if (menuToggle && hamburgerMenu && menuOverlay) {
        menuToggle.onclick = () => {
            hamburgerMenu.classList.toggle('open');
            menuOverlay.style.display = hamburgerMenu.classList.contains('open') ? 'block' : 'none';
        };
        menuOverlay.onclick = () => {
            hamburgerMenu.classList.remove('open');
            menuOverlay.style.display = 'none';
        };
    } else {
        console.error("Salah satu elemen hamburger menu tidak ditemukan.");
    }
});

function updateThemeAndLabels(tipeAkun) {
    if (tipeAkun === 'penerima') {
        document.body.classList.add('penerima-theme');
        document.querySelector('#keluar h2').textContent = 'Uang diterima';
        document.querySelector('#masuk h2').textContent = 'Uang yang dikembalikan';
    } else {
        document.body.classList.remove('penerima-theme');
        document.querySelector('#keluar h2').textContent = 'Uang dipinjamkan';
        document.querySelector('#masuk h2').textContent = 'Uang dikembalikan';
    }
}

function updateUIBasedOnAccountType(tipeAkun) {
    const isPeminjam = (tipeAkun === 'peminjam');
    tambahNasabahBtn.style.display = isPeminjam ? 'block' : 'none';
}

switchAkun.onchange = async (e) => {
    const newTipeAkun = e.target.value;
    const { error } = await supabaseClient
        .from('profiles')
        .update({ tipe_akun: newTipeAkun })
        .eq('id', currentUserId);
    if (!error) {
        userProfile.tipe_akun = newTipeAkun;
        updateThemeAndLabels(newTipeAkun);
        updateUIBasedOnAccountType(newTipeAkun); // Update UI elements
        fetchData();
    } else {
        alert('Gagal mengganti tipe akun: ' + error.message);
    }
};

logoutBtn.onclick = async () => {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
        debugLog("❌ Error logout", error);
        alert('Gagal logout: ' + error.message);
    } else {
        debugLog("✅ User logout sukses");
        setTimeout(() => {
            window.location.href = "index.html";
        }, 500);
    }
};

tambahBtn.onclick = () => {
    if (!selectedFriendId) {
        alert('Silakan pilih nasabah dari daftar terlebih dahulu sebelum menambahkan catatan.');
        return;
    }
    modalForm.style.display = 'flex';
    nominal.value = '';
    tanggal.value = '';
    bukti.value = '';
    mainTitle.textContent = `Tambah catatan untuk ${selectedFriendName}`;
};

batalBtn.onclick = () => modalForm.style.display = 'none';
modalForm.onclick = (e) => {
    if (e.target === modalForm) modalForm.style.display = 'none';
}
tutupBukti.onclick = () => modalBukti.style.display = 'none';
modalBukti.onclick = (e) => {
    if (e.target === modalBukti) modalBukti.style.display = 'none';
}

// --- KODE UNTUK MODAL TAMBAH/CARI NASABAH ---
tambahNasabahBtn.onclick = () => {
    modalNasabah.style.display = 'flex';
    inputNasabahNama.value = '';
    inputNasabahEmail.value = '';
    hamburgerMenu.classList.remove('open');
    menuOverlay.style.display = 'none';
};
batalNasabahBtn.onclick = () => modalNasabah.style.display = 'none';
modalNasabah.onclick = (e) => {
    if (e.target === modalNasabah) modalNasabah.style.display = 'none';
};

simpanNasabahBtn.onclick = async () => {
    const nama = inputNasabahNama.value.trim();
    const email = inputNasabahEmail.value.trim();
    if (!nama || !email) {
        return alert('Nama dan email harus diisi.');
    }

    const { data: profileData, error } = await supabaseClient
        .from('profiles')
        .select('id, nama, email')
        .ilike('nama', nama)
        .ilike('email', email)
        .maybeSingle();

    modalNasabah.style.display = 'none';
    inputNasabahNama.value = '';
    inputNasabahEmail.value = '';

    if (error) {
        alert('❌ Terjadi kesalahan: ' + error.message);
        debugLog("❌ Error cari nasabah", error);
        return;
    }

    if (profileData) {
        const { error: insertError } = await supabaseClient
            .from('user_nasabah')
            .insert([{
                user_id: currentUserId,
                nasabah_id: profileData.id
            }]);

        if (insertError) {
            debugLog("⚠️ Gagal simpan nasabah", insertError);
            alert('⚠️ Nasabah sudah ada atau gagal disimpan.');
        } else {
            debugLog("✅ Nasabah berhasil ditambahkan", profileData);
        }

        loadNasabahList();
    } else {
        alert(`ℹ️ Nasabah dengan nama "${nama}" dan email "${email}" tidak ditemukan.`);
    }
};

function fetchDataByFriend(friendId, friendName, element) {
    selectedFriendId = friendId;
    selectedFriendName = friendName;
    mainTitle.textContent = `Pinjaman dengan ${friendName}`;
    
    document.querySelectorAll('#friendsList .found-nasabah').forEach(li => {
        li.classList.remove('selected');
    });

    if (element) {
      element.classList.add('selected');
    }

    fetchData();
    hamburgerMenu.classList.remove('open');
    menuOverlay.style.display = 'none';
}

async function fetchData() {
    if (!currentUserId || !userProfile) {
        console.warn("User ID atau Profil belum tersedia.");
        return;
    }

    let query = supabaseClient.from('pinjaman').select('*');

    if (selectedFriendId) {
        query = query.or(`and(peminjam_user_id.eq.${currentUserId},penerima_user_id.eq.${selectedFriendId}),and(penerima_user_id.eq.${currentUserId},peminjam_user_id.eq.${selectedFriendId})`);
    } else {
        query = query.or(`peminjam_user_id.eq.${currentUserId},penerima_user_id.eq.${currentUserId}`);
    }

    const { data, error } = await query.order('tanggal_pinjam', {
        ascending: false
    });

    if (error) {
        alert('Error saat mengambil data: ' + error.message);
        console.error('Error fetching data:', error);
        return;
    }

    allLoanData = data;
    let filteredDataKeluar, filteredDataMasuk;

    if (userProfile.tipe_akun === 'peminjam') {
        filteredDataKeluar = allLoanData.filter(item => item.peminjam_user_id === currentUserId && item.jenis === 'dipinjamkan');
        filteredDataMasuk = allLoanData.filter(item => item.peminjam_user_id === currentUserId && item.jenis === 'dikembalikan');
    } else {
        filteredDataKeluar = allLoanData.filter(item => item.penerima_user_id === currentUserId && item.jenis === 'dipinjamkan');
        filteredDataMasuk = allLoanData.filter(item => item.penerima_user_id === currentUserId && item.jenis === 'dikembalikan');
    }

    const h2Keluar = document.querySelector('#keluar h2');
    const h2Masuk = document.querySelector('#masuk h2');

    h2Keluar.textContent = userProfile.tipe_akun === 'peminjam' ? 'Uang dipinjamkan' : 'Uang diterima';
    h2Masuk.textContent = userProfile.tipe_akun === 'peminjam' ? 'Uang dikembalikan' : 'Uang yang dikembalikan';

    renderList(listKeluar, filteredDataKeluar);
    renderList(listMasuk, filteredDataMasuk);
    updateTotals(filteredDataKeluar, filteredDataMasuk);
}

simpanBtn.onclick = async () => {
    const jenisPinjaman = jenis.value;
    const nominalValue = parseInt(nominal.value.replace(/[^0-9]/g, '')) || 0;
    const tgl = tanggal.value;
    const file = bukti.files[0];
    

if (!selectedFriendId) {
    alert('Silakan pilih nasabah dari daftar atau tambahkan nasabah baru terlebih dahulu.');
    return;
}

let peminjamId = null;
let penerimaId = null;

if (userProfile.tipe_akun === 'peminjam') {
    if (jenisPinjaman === 'dipinjamkan') {
        peminjamId = currentUserId;
        penerimaId = selectedFriendId;
    } else {
        penerimaId = currentUserId;
        peminjamId = selectedFriendId;
    }
} else {
    if (jenisPinjaman === 'dipinjamkan') {
        penerimaId = currentUserId;
        peminjamId = selectedFriendId;
    } else {
        peminjamId = currentUserId;
        penerimaId = selectedFriendId;
    }
}

    let bukti_url = null;
    if (file) {
        const fileName = `${currentUserId}/${Date.now()}-${file.name}`;
        const { error: uploadError } = await supabaseClient.storage
            .from('uploads')
            .upload(fileName, file);
        if (uploadError) {
            alert('❌ Gagal mengunggah gambar: ' + uploadError.message);
            console.error('Upload Error:', uploadError);
            return;
        }
        const { data: publicUrlData } = supabaseClient.storage
            .from('uploads')
            .getPublicUrl(fileName);
        bukti_url = publicUrlData.publicUrl;
    }

    const { error: insertError } = await supabaseClient
        .from('pinjaman')
        .insert([{
            peminjam_user_id: peminjamId,
            penerima_user_id: penerimaId,
            jumlah: nominalValue,
            tanggal_pinjam: tgl,
            jenis: jenisPinjaman,
            bukti_url: bukti_url,
            nama_nasabah: selectedFriendName
        }]);

    if (insertError) {
        alert('❌ Gagal menyimpan data: ' + insertError.message);
        console.error('Insert Error:', insertError);
    } else {
        modalForm.style.display = 'none';
        fetchData();
    }
};

async function loadNasabahList() {
    if (!currentUserId) {
        debugLog("⚠️ currentUserId kosong, tidak bisa load nasabah");
        return;
    }
    
    const { data: relationsPeminjam, error: errorPeminjam } = await supabaseClient
        .from("user_nasabah")
        .select(`
            nasabah_id,
            profiles:nasabah_id (id, nama, email)
        `)
        .eq("user_id", currentUserId);

    if (errorPeminjam) {
        debugLog("❌ Gagal mengambil relasi sebagai peminjam", errorPeminjam);
    }
    
    const { data: relationsPenerima, error: errorPenerima } = await supabaseClient
        .from("user_nasabah")
        .select(`
            user_id,
            profiles:user_id (id, nama, email)
        `)
        .eq("nasabah_id", currentUserId);
    
    if (errorPenerima) {
        debugLog("❌ Gagal mengambil relasi sebagai penerima", errorPenerima);
    }
    
    const allRelations = [...(relationsPeminjam || []), ...(relationsPenerima || [])];
    const uniqueFriends = new Map();

    allRelations.forEach(rel => {
        if (rel.profiles) {
            uniqueFriends.set(rel.profiles.id, rel.profiles);
        }
    });

    friendsList.innerHTML = "";

    if (uniqueFriends.size === 0) {
        debugLog("ℹ️ Tidak ada relasi nasabah untuk user ini.");
        friendsList.innerHTML = '<p style="padding: 10px; color: #888;">Belum ada nasabah.</p>';
        return;
    }

    uniqueFriends.forEach((profile) => {
        const li = document.createElement("li");
        li.className = "found-nasabah";
        li.textContent = `👤 ${profile.nama} (${profile.email})`;
        li.onclick = (e) =>
            fetchDataByFriend(profile.id, profile.nama, e.currentTarget);
        friendsList.appendChild(li);
    });

    debugLog("✅ Daftar nasabah berhasil dimuat", uniqueFriends.size);
}

// FUNGSI MARKASRETURNED SEKARANG MENAMPILKAN MODAL
window.markAsReturned = async (id) => {
    loanToRepayId = id;
    const loanData = allLoanData.find(item => item.id === id);
    if (!loanData) {
        alert("Data pinjaman tidak ditemukan.");
        return;
    }

    nominalAsli.value = formatRupiah(loanData.jumlah);
    tanggalPinjamAsli.value = loanData.tanggal_pinjam;
    tanggalDikembalikan.value = new Date().toISOString().slice(0, 10);
    buktiKembali.value = null;

    modalLunasi.style.display = 'flex';
};

// SIMPAN DARI MODAL LUNASI
simpanLunasiBtn.onclick = async () => {
    if (!loanToRepayId) {
        alert("Tidak ada pinjaman yang dipilih.");
        return;
    }

    const tglKembali = tanggalDikembalikan.value;
    const file = buktiKembali.files[0];

    if (!tglKembali) {
        alert('Tanggal pengembalian harus diisi.');
        return;
    }

    let bukti_url_kembali = null;
    if (file) {
        const fileName = `${currentUserId}/${Date.now()}-${file.name}`;
        const { error: uploadError } = await supabaseClient.storage
            .from('uploads')
            .upload(fileName, file);
        if (uploadError) {
            alert('❌ Gagal mengunggah gambar: ' + uploadError.message);
            console.error('Upload Error:', uploadError);
            return;
        }
        const { data: publicUrlData } = supabaseClient.storage
            .from('uploads')
            .getPublicUrl(fileName);
        bukti_url_kembali = publicUrlData.publicUrl;
    }

    const { error: updateError } = await supabaseClient
        .from('pinjaman')
        .update({
            jenis: 'dikembalikan',
            tanggal_dikembalikan: tglKembali,
            bukti_dikembalikan_url: bukti_url_kembali
        })
        .eq('id', loanToRepayId);

    if (updateError) {
        alert('❌ Gagal menandai sebagai dikembalikan: ' + updateError.message);
        console.error('Update Loan Error:', updateError);
    } else {
        alert('✅ Pinjaman berhasil ditandai sebagai dikembalikan!');
        modalLunasi.style.display = 'none';
        fetchData();
    }
};

batalLunasiBtn.onclick = () => modalLunasi.style.display = 'none';
modalLunasi.onclick = (e) => {
    if (e.target === modalLunasi) modalLunasi.style.display = 'none';
}

async function hapusData(id, bukti_url, bukti_kembali_url) {
    if (!confirm('Apakah Anda yakin ingin menghapus catatan ini?')) {
        return;
    }

    const filesToDelete = [];
    if (bukti_url && bukti_url !== 'null' && bukti_url !== 'undefined') {
        const pathSegments = bukti_url.split('/uploads/')[1];
        if (pathSegments) {
            filesToDelete.push(pathSegments);
        }
    }
    if (bukti_kembali_url && bukti_kembali_url !== 'null' && bukti_kembali_url !== 'undefined') {
        const pathSegments = bukti_kembali_url.split('/uploads/')[1];
        if (pathSegments) {
            filesToDelete.push(pathSegments);
        }
    }
    if (filesToDelete.length > 0) {
        const { error: storageError } = await supabaseClient.storage
            .from('uploads')
            .remove(filesToDelete);
        if (storageError) {
            alert('❌ Error saat menghapus gambar dari storage: ' + storageError.message);
            console.error('Storage Delete Error:', storageError);
        }
    }
    const { error: deleteError } = await supabaseClient
        .from('pinjaman')
        .delete()
        .eq('id', id);
    if (deleteError) {
        alert('❌ Gagal menghapus data: ' + deleteError.message);
        console.error('Delete Error:', deleteError);
    } else {
        fetchData();
    }
}

function renderList(container, data) {
    container.innerHTML = '';
    if (data.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--light-text-color);">Belum ada catatan.</p>';
        return;
    }
    data.forEach((d) => {
        const div = document.createElement('div');
        div.className = 'item';

        let lunasiButton = '';
        if (d.jenis === 'dipinjamkan') {
            lunasiButton = `<button style="background: #4CAF50;" onclick="markAsReturned('${d.id}')">Lunasi</button>`;
        }
        
        let deleteButton = '';
        if (userProfile.tipe_akun === 'peminjam') {
            deleteButton = `<button style="background-color: #f44336;" onclick="hapusData('${d.id}', '${d.bukti_url}', '${d.bukti_dikembalikan_url}')">Hapus</button>`;
        }

        const tanggalTampil = d.jenis === 'dipinjamkan' ? d.tanggal_pinjam : d.tanggal_dikembalikan;
        
        let buktiButtons = '';
        if (d.bukti_url) {
             buktiButtons += `<button onclick="lihatBukti('${d.bukti_url}')">Lihat Bukti Pinjam</button>`;
        }
        if (d.bukti_dikembalikan_url) {
            buktiButtons += `<button onclick="lihatBukti('${d.bukti_dikembalikan_url}')">Lihat Bukti Kembali</button>`;
        }

        div.innerHTML = `
            <div class="item-info">
                <span>${formatRupiah(d.jumlah)}<br><small>${tanggalTampil}</small></span>
            </div>
            <div>
                ${d.jenis === 'dipinjamkan' ? lunasiButton : ''}
                ${buktiButtons}
                ${deleteButton}
            </div>
        `;
        container.appendChild(div);
    });
}

function updateTotals(dataKeluar, dataMasuk) {
    const totalK = dataKeluar.reduce((a, b) => a + b.jumlah, 0);
    const totalM = dataMasuk.reduce((a, b) => a + b.jumlah, 0);
    const saldo = totalK - totalM;

    const labelKeluar = userProfile.tipe_akun === 'peminjam' ? 'Dipinjamkan' : 'Diterima';
    const labelMasuk = userProfile.tipe_akun === 'peminjam' ? 'Dikembalikan' : 'Dikembalikan';

    totalKeluar.textContent = `Total ${labelKeluar}: ${formatRupiah(totalK)}`;
    totalMasuk.textContent = `Total ${labelMasuk}: ${formatRupiah(totalM)}`;
    saldoEl.textContent = `Saldo (Belum Kembali): ${formatRupiah(saldo)}`;
    saldoRingkas.textContent = `Saldo: ${formatRupiah(saldo)}`;
}

window.lihatBukti = (src) => {
    imgBukti.src = src;
    modalBukti.style.display = 'flex';
};
window.hapusData = hapusData;
</script>
</body>
</html>